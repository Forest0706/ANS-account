# 物流財務台帳管理システム - 完全開発仕様書

## 目次
1. [システム概要](#システム概要)
2. [会社基本情報](#会社基本情報)
3. [機能モジュール詳細](#機能モジュール詳細)
4. [技術仕様](#技術仕様)
5. [データベース設計](#データベース設計)
6. [PDF出力仕様](#pdf出力仕様)
7. [開発優先順位](#開発優先順位)

---

## 1. システム概要

**目的：** 物流貨物代理業向けの財務台帳管理システム  
**主要機能：** 進出口業務の費用収支・決済・支払フロー管理  
**言語：** 日本語UI（開発者との会話は中国語可）  
**データ保存：** ローカルストレージ（localStorage）

---

## 2. 会社基本情報

```javascript
const companySettings = {
  companyName: "アンササプライチェーン株式会社",
  companyNameEn: "ANSWER SUPPLY CHAIN CO., LTD.",
  postalCode: "〒231-0015",
  address: "神奈川県横浜市中区尾上町4-54 KANNAI EX 4F",
  registrationNo: "T5020001157840",
  tel: "",  // システムで設定可能
  fax: "",  // システムで設定可能
  
  // 振込先情報
  bankName: "三井住友銀行",
  branchName: "横浜支店",
  accountType: "普通",
  accountNumber: "7665574",
  accountName: "ｱﾝｻｻﾌﾟﾗｲﾁｪｰﾝ（ｶ"
}
```

---

## 3. 機能モジュール詳細

### 3.1 往来単位管理（取引先マスタ）

**画面構成：** リスト表示 + CRUD機能

**フィールド定義：**

| フィールド名 | タイプ | 採番/検証ルール | 必須 | 備考 |
|------------|--------|----------------|------|------|
| 取引先CD | テキスト | ANSC-010000から自動採番 | ✅ | 読取専用 |
| 会社名 | テキスト | - | ✅ | 日本語対応 |
| 取引先区分 | 複数選択 | 【顧客】【仕入先】 | ✅ | 台帳結算単位の絞り込み用 |
| 連絡先 | テキスト | 電話番号形式 | - | 任意 |
| 郵便番号 | テキスト | 7桁数字（XXX-XXXX） | - | 形式検証 |
| 住所 | テキスト | - | ✅ | 完全住所 |
| 法人番号 | テキスト | 13桁数字 | - | 形式検証 |
| 営業担当 | ドロップダウン | 担当者リストから選択 | - | 任意 |
| デフォルト支払条件 | ドロップダウン | 支払条件マスタから選択 | - | 任意 |

**機能要件：**
- 新規作成・編集・削除
- 検索・フィルター・ソート
- ページネーション対応
- 取引先区分による絞り込み（台帳作成時に使用）

---

### 3.2 費用項目マスタ

**画面構成：** リスト表示 + CRUD機能

**フィールド定義：**

| フィールド名 | タイプ | 選択肢/形式 | 必須 |
|------------|--------|------------|------|
| 費用項目名 | テキスト | 例：海上運賃立替費用 | ✅ |
| 費用コード | テキスト | 項目名と同期または独自設定 | ✅ |
| 通貨 | ドロップダウン | JPY/USD/CNY 等 | ✅ |
| 計費単位 | ドロップダウン | 件/葉/時間/40HQ/20GP 等 | ✅ |
| 税区分 | ラジオボタン | 【免税】【課税】 | ✅ |
| 備考 | テキストエリア | - | - |

**機能要件：**
- CRUD機能
- 台帳明細から参照可能
- 税区分別表示・フィルター

---

### 3.3 支払条件マスタ

**画面構成：** リスト表示 + CRUD機能

**フィールド定義：**

| フィールド名 | タイプ | 説明 | 必須 |
|------------|--------|------|------|
| 支払条件名 | テキスト | 例：月末締め翌月末払い | ✅ |
| 条件区分 | ラジオボタン | 【締日】【天数計算】 | ✅ |
| 締日 | ドロップダウン | 1-31日選択（締日モード時必須） | 条件付き |
| 支払期限 | テキスト | 例：次月/31日（締日モード時） | 条件付き |
| 天数 | 数値 | 例：30（天数モード時必須） | 条件付き |
| ステータス | ラジオボタン | 【有効】【無効】 | ✅ |

**計算ロジック：**

```javascript
// 締日モード
if (条件区分 === '締日') {
  // 請求日の月末を締日として、翌月指定日を支払期限とする
  支払期限 = 翌月 + '/' + 締日 + '日';
}

// 天数モード
if (条件区分 === '天数計算') {
  支払期限 = 請求日 + 天数;
}
```

**機能要件：**
- CRUD機能
- 台帳ヘッダーから自動参照
- 支払期限自動計算

---

### 3.4 台帳管理（コア機能）

#### 3.4.1 用語定義

- **台帳リスト** = メイン一覧画面（台帳の検索・表示）
- **請求書ページ** = 台帳詳細画面（基礎海運データ + 子請求書管理）
- **子請求書** = 請求書ページ内で作成される個別請求（複数作成可）

#### 3.4.2 台帳番号採番ルール

```javascript
// 母台帳番号：ANS-YYMM0001（年月+連番）
// 例：ANS-250100001（2025年01月1件目）

// 子請求書番号：母台帳番号 + アルファベットサフィックス
// 1つ目：ANS-250100001-A
// 2つ目：ANS-250100001-B
// 3つ目：ANS-250100001-C

const generateChildInvoiceNumber = (parentNumber, index) => {
  const suffix = String.fromCharCode(65 + index); // A, B, C...
  return `${parentNumber}-${suffix}`;
}
```

#### 3.4.3 台帳リスト画面

**表示項目：**
- 台帳番号
- 顧客名
- 船名航次
- B/L番号
- 作成日
- 担当者
- ステータス

**機能：**
- CRUD機能（母台帳）
- 検索・フィルター・ソート
- 詳細画面へ遷移

#### 3.4.4 請求書ページ - Tab1：基礎海運データ

| フィールド名 | タイプ | 必須 |
|------------|--------|------|
| 顧客名 | ドロップダウン（取引先マスタ） | ✅ |
| 本船名 | テキスト | ✅ |
| 航次 (Voy.) | テキスト | - |
| 船荷証券番号 (B/L No.) | テキスト | ✅ |
| 品名 | テキスト | - |
| 船会社 | テキスト | - |
| コンテナ番号 (CTNR) | テキスト | - |
| 出港日 (ETD) | 日付 | - |
| 入港日 (ETA) | 日付 | - |
| 積港 (POL) | テキスト | - |
| 揚港 (POD) | テキスト | - |
| 数量 | テキスト | - |
| 重量 | テキスト | - |
| 容積 | テキスト | - |
| 許可番号 | テキスト | - |
| インボイス番号 (INV No.) | テキスト | - |
| 備考 | テキストエリア | - |

**注意：** このデータは全ての子請求書から共通参照される

#### 3.4.5 請求書ページ - Tab2：台帳（子請求書管理）

**子請求書ヘッダー情報：**

| フィールド名 | タイプ | 説明 | 必須 |
|------------|--------|------|------|
| 請求番号 | 表示のみ | 自動生成（ANS-250100001-A） | - |
| 結算単位 | ドロップダウン | 取引先マスタから選択 | ✅ |
| 請求区分 | ラジオボタン | 【通常請求】【立替請求】 | ✅ |
| 請求日 | 日付ピッカー | - | ✅ |
| 支払期限 | 表示のみ | 支払条件から自動計算 | - |
| 備考 | テキストエリア | - | - |

**収費費率テーブル（請求側・上部）：**

| 項目 | タイプ | 説明 |
|------|--------|------|
| ステータス | ドロップダウン | 【未確認】→【確認済】→【請求済】→【入金済】 |
| 請求項目 | ドロップダウン | 費用項目マスタから選択 |
| 数量 | 数値 | - |
| 単位 | 表示のみ | 費用項目から自動取得 |
| 区分 | 表示のみ | 費用項目から自動取得【免税】【課税】 |
| 通貨 | 表示のみ | 費用項目から自動取得 |
| 単価 | 数値 | - |
| Rate | 数値 | 為替レート、デフォルト1 |
| 金額 | 表示のみ | 自動計算 = 単価 × 数量 × Rate |
| 備考 | テキスト | - |

**収費機能：**
- 各行CRUD機能
- 「確認済」ステータス以降はロック（編集不可）
- ステータス戻し機能あり
- 結算単位絞り込み：取引先区分に「顧客」を含む取引先のみ表示

**付費費率テーブル（支払側・下部）：**

収費テーブルのフィールドに加えて：

| 追加項目 | タイプ | 説明 |
|---------|--------|------|
| 下付請求日 | 日付ピッカー | 収費と独立設定可 |
| 結算単位 | ドロップダウン | 収費と独立、仕入先選択可 |

**付費特殊機能：**
- 「収費コピー」ボタン：収費費率の全内容を付費に一括コピー
- 費用項目レベルで結算単位・請求日を個別管理
- 各行CRUD機能
- 結算単位絞り込み：取引先区分に「仕入先」を含む取引先のみ表示

#### 3.4.6 集計ロジック（重要）

```javascript
// ========== 収費集計 ==========
収費課税外合計 = SUM(収費テーブルで区分='免税' の金額)
収費課税対象合計 = SUM(収費テーブルで区分='課税' の金額)
収費消費税 = Math.round(収費課税対象合計 × 0.1)  // 四捨五入
収費合計 = 収費課税外合計 + 収費課税対象合計 + 収費消費税

// ========== 付費集計 ==========
付費課税外合計 = SUM(付費テーブルで区分='免税' の金額)
付費課税対象合計 = SUM(付費テーブルで区分='課税' の金額)
付費消費税 = Math.round(付費課税対象合計 × 0.1)  // 四捨五入
付費合計 = 付費課税外合計 + 付費課税対象合計 + 付費消費税

// ========== 粗利計算 ==========
粗利（税抜） = (収費課税外合計 + 収費課税対象合計) - (付費課税外合計 + 付費課税対象合計)
粗利（税込） = 収費合計 - 付費合計
```

**重要ポイント：**
- ❗ 消費税は課税項目の合計に対して1回のみ計算（個別行ごとではない）
- ❗ 消費税は四捨五入
- ❗ 免税項目は消費税計算に含まない

---

## 4. 技術仕様

### 4.1 UI/UX要件

- レスポンシブデザイン（PC対応優先）
- 日本語インターフェース
- テーブルソート・フィルター機能
- ドロップダウン検索対応（Select2風）
- モーダルウィンドウでフォーム表示
- ローディング表示

### 4.2 データ検証

```javascript
// 必須項目バリデーション
- 取引先CD、会社名、台帳番号等

// フォーマット検証
- 郵便番号：XXX-XXXX
- 法人番号：13桁数字
- 電話番号：XXX-XXXX-XXXX

// 日付論理検証
- 支払期限 >= 請求日

// 数値検証
- 単価、数量、Rate > 0
```

### 4.3 計算エンジン

- リアルタイム金額計算（単価×数量×Rate）
- 消費税自動計算（課税合計×10%、四捨五入）
- 自動集計統計（課税外/課税/消費税/合計）
- 支払期限自動計算

### 4.4 権限制御（将来実装）

- 担当者：自分の台帳のみ編集可
- 承認者：ステータス変更可
- 経理担当：全データ閲覧可

### 4.5 データ連携

```
取引先マスタ → 台帳（結算単位選択、取引先区分で絞り込み）
費用項目マスタ → 台帳明細（費用情報引用）
支払条件マスタ → 支払期限計算
基礎海運データ → 全子請求書（共通参照）
```

---

## 5. データベース設計

### 5.1 主要テーブル構造

#### **取引先マスタ (torihikisaki_master)**
```javascript
{
  id: "auto_increment",
  torihikisaki_cd: "ANSC-010000",
  company_name: "株式会社富士",
  kubun: ["顧客", "仕入先"], // 複数選択
  tel: "022-221-2109",
  postal_code: "XXX-XXXX",
  address: "...",
  houjin_no: "5370001007432",
  tanto: "担当者名",
  default_shiharai_joken_id: "支払条件ID",
  created_at: "timestamp",
  updated_at: "timestamp"
}
```

#### **費用項目マスタ (hiyo_koumoku_master)**
```javascript
{
  id: "auto_increment",
  koumoku_name: "海上運賃立替費用",
  koumoku_code: "BL LATE PICK FEE",
  currency: "JPY",
  tani: "件",
  zei_kubun: "免税", // or "課税"
  bikou: "",
  created_at: "timestamp"
}
```

#### **支払条件マスタ (shiharai_joken_master)**
```javascript
{
  id: "auto_increment",
  joken_name: "月末締め翌月末払い",
  kubun: "締日", // or "天数計算"
  shimebi: 31, // 締日モード時
  shiharai_kigen: "次月/31日", // 締日モード時
  tensuu: null, // 天数モード時
  status: "有効",
  created_at: "timestamp"
}
```

#### **台帳ヘッダー (daicho_header)**
```javascript
{
  id: "auto_increment",
  daicho_no: "ANS-250100001",
  kokyaku_id: "取引先ID",
  honsen_name: "RUI HANG TENG FEI",
  koji: "L2516E",
  bl_no: "SITGWUYOS12348",
  hinmei: "1300 CARTON(S)",
  funakaisha: "SITC",
  ctnr_no: "40HQx1",
  etd: "2025-08-15",
  eta: "2025-08-31",
  pol: "SHANGHAI,CHINA",
  pod: "YOKOHAMA,JAPAN",
  suuryou: "1300 CARTON(S)",
  juryou: "5,590.000KGS",
  youseki: "61.442m3",
  kyoka_no: "216 2281 6600",
  inv_no: "25NFCC6148",
  bikou: "",
  created_at: "timestamp",
  updated_at: "timestamp"
}
```

#### **子請求書 (ko_seikyu)**
```javascript
{
  id: "auto_increment",
  parent_daicho_id: "母台帳ID",
  seikyu_no: "ANS-250100001-A",
  kessai_tani_id: "結算単位ID（取引先ID）",
  seikyu_kubun: "通常請求", // or "立替請求"
  seikyu_date: "2025-09-30",
  shiharai_kigen: "2025-11-10", // 自動計算
  bikou: "",
  status: "未確認", // 未確認/確認済/請求済/入金済
  created_at: "timestamp",
  updated_at: "timestamp"
}
```

#### **収費明細 (shuhi_meisai)**
```javascript
{
  id: "auto_increment",
  ko_seikyu_id: "子請求書ID",
  koumoku_id: "費用項目ID",
  suuryou: 1,
  tani: "件",
  kubun: "免税", // or "課税"
  currency: "JPY",
  tanka: 233376,
  rate: 1,
  kingaku: 233376, // 自動計算
  bikou: "",
  created_at: "timestamp"
}
```

#### **付費明細 (fuhi_meisai)**
```javascript
{
  id: "auto_increment",
  ko_seikyu_id: "子請求書ID",
  koumoku_id: "費用項目ID",
  shitatsuke_seikyu_date: "2025-09-30", // 収費と独立
  kessai_tani_id: "仕入先ID", // 収費と独立
  suuryou: 1,
  tani: "件",
  kubun: "免税",
  currency: "JPY",
  tanka: 180000,
  rate: 1,
  kingaku: 180000,
  bikou: "",
  created_at: "timestamp"
}
```

---

## 6. PDF出力仕様（ANSシンプル版）

### 6.1 レイアウト構成

```
                        請 求 書

{結算単位名} 御中                                    No      ANS-250100001-A
                                                    請求日   2025年09月19日

下記のとおり、御請求申し上げます。                        
                                                    アンササプライチェーン株式会社
件名        {件名/BL番号}                             〒231-0015
支払期限    2025年09月24日                             神奈川県横浜市中区尾上町4-54
振込先      三井住友銀行 横浜支店                        KANNAI EX 4F
           普通 7665574 ｱﾝｻｻﾌﾟﾗｲﾁｪｰﾝ（ｶ                登録番号：T5020001157840

合計金額            ¥115,800 円

┌─────────────────────────────────────────┐
│ 摘要          │ 数量 │ 単位 │ 単価   │ 金額      │
├─────────────────────────────────────────┤
│ {費用項目1}   │  1   │ 件   │ 14,300 │  14,300   │
│ {費用項目2}   │  1   │ 件   │ 79,200 │  79,200   │
│ {費用項目3}   │  2   │ 時間 │  5,000 │  10,000   │
└─────────────────────────────────────────┘
                                          合計   115,800

┌───────────────────────────────┐
│ 税率別内訳  │ 税抜金額 │ 消費税 │ 税込金額 │
├───────────────────────────────┤
│ 課税対象   │  50,000  │ 5,000  │  55,000  │
│ 免税対象   │  60,800  │   0    │  60,800  │
└───────────────────────────────┘

備考
＊お振込手数料はご負担願います。
＊【*】は課税項目になります。
```

### 6.2 実装要件

- HTML → PDF変換（jsPDF または html2pdf.js）
- A4サイズ、縦向き
- フォント：ゴシック体
- 自動改ページ対応
- ダウンロードファイル名：`請求書_{請求番号}_{YYYYMMDD}.pdf`

---

## 7. 開発優先順位

### Phase 1（MVP）
1. 取引先マスタ（CRUD）
2. 費用項目マスタ（CRUD）
3. 支払条件マスタ（CRUD）
4. 台帳管理（基本CRUD）

### Phase 2（コア機能）
5. 子請求書作成機能
6. 収費・付費明細CRUD
7. 自動計算ロジック実装

### Phase 3（完成）
8. ステータス管理・ロック機能
9. PDF出力機能
10. データバックアップ/リストア

---

## 8. アウトプット要件

### 8.1 必須機能

- 完全なHTML構造
- 全計算ロジック含むJavaScript
- レスポンシブCSS
- localStorage機能（JSON形式）
- PDF出力機能
- データエクスポート/インポート（バックアップ用）

### 8.2 推奨ライブラリ

```javascript
// 必須
- なし（Vanilla JavaScript）

// 推奨
- jsPDF (PDF生成)
- html2canvas (PDF用スクリーンショット)
- または html2pdf.js (統合ソリューション)
```

### 8.3 ブラウザ対応

- Chrome 最新版
- Edge 最新版
- Firefox 最新版
- Safari 最新版（macOS/iOS）

---

**以上、完全開発仕様書**